---
- name: Install Apache
  sudo: yes
  apt: pkg=apache2 state=latest

- name: Install Apache Modules
  apache2_module: state=present name={{ item }}
  notify: restart apache
  with_items:
    - rewrite
    - vhost_alias
    - headers
    - expires
    - filter
    - ssl

- shell: apache2 -v
  register: apache_version

- name: Change default apache2.4 site
  sudo: yes
  template: src=vhost24.conf.tpl dest=/etc/apache2/sites-available/000-default.conf
  notify: restart apache
  when: apache_version.stdout.find('Apache/2.4.') != -1

- name: Change default apache2.2 site
  sudo: yes
  template: src=vhost22.conf.tpl dest=/etc/apache2/sites-available/default
  notify: restart apache
  when: apache_version.stdout.find('Apache/2.2.') != -1
    
-   name: Change apache user to vagrant
    notify: restart apache
    lineinfile: dest=/etc/apache2/envvars
                regexp='export APACHE_RUN_USER=www-data'
                line='export APACHE_RUN_USER=vagrant'
                
-   name: Change apache group to vagrant
    lineinfile: dest=/etc/apache2/envvars
                regexp='export APACHE_RUN_GROUP=www-data'
                line='export APACHE_RUN_GROUP=vagrant'
    notify: restart apache
        
-   name: Create SSL key folder
    sudo: yes
    file: path="/etc/apache2/ssl"
          state="directory"
          owner="root"
    
-   name: Generate SSL Key
    sudo: yes
    command: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/apache2/ssl/{{servername}}.key -out /etc/apache2/ssl/{{servername}}.crt -subj '/CN={{servername}}/O=Vagrant VM/C=US'
    notify: restart apache
    args:
        creates: /etc/apache2/ssl/{{servername}}.key
