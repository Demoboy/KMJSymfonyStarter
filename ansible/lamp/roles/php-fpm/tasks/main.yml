
- name: Install php5-fpm
  sudo: yes
  apt: pkg=php5-fpm state=latest
  
  
-   name: Setup php.ini
    sudo: yes
    lineinfile: dest="/etc/php5/fpm/php.ini"
                regexp="{{ item.reg }}"
                line="{{ item.line }}"
    with_items:
        - { reg: 'date.timezone =', line: 'date.timezone = {{ timezone }}' }
        - { reg: 'max_execution_time =', line: 'max_execution_time = 0' }
        - { reg: 'xdebug.max_nesting_level =', line: 'xdebug.max_nesting_level = {{ max_nesting_level }}' }
        - { reg: 'memory_limit =', line: 'memory_limit = {{ memory_limit }}' }
        - { reg: 'display_errors =', line: 'display_errors = true' }
        - { reg: 'display_startup_errors =', line: 'display_startup_errors = true' }
        - { reg: 'error_reporting =', line: 'error_reporting = E_ALL' }


- name: Install Apache fcgid
  sudo: yes
  apt: pkg=libapache2-mod-fcgid state=latest
  
- name: Enable needed apache mods
  apache2_module: name={{ item }} state=present
  with_items:
    - proxy
    - proxy_fcgi
    - fcgid
    
- name: Setup fpm config
  lineinfile: dest=/etc/php5/fpm/php-fpm.conf
            create=no
            regexp="{{ item.reg }}"
            line="{{ item.line }}"
  with_items:
    - { reg: 'user = ', line: "user = vagrant"}
    - { reg: 'group = ', line: 'group = vagrant'}
    - { reg: 'listen = ', line: 'listen = 127.0.0.1:9000' } 
  notify: use FPM